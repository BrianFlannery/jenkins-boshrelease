#!/bin/bash -eu


# Setup env vars and folders for the script
cd $(dirname ${BASH_SOURCE[0]})/..

export JAVA_HOME=/var/vcap/packages/openjre_8

JOB_NAME=$(basename $PWD)
JOB_DIR=/var/vcap/jobs/$JOB_NAME
source $JOB_DIR/helpers/ctl_setup.sh $JOB_NAME

# [[ $PORT ]] || export PORT=<%= p('jenkins_master.httpPort') %>
[[ $PORT ]] || export PORT=<%= p('jenkins.server.internal_http_port') %>


export PORT=${PORT:-8090}







export LANG=en_US.UTF-8

export JENKINS_HOME=/var/vcap/store/jenkins_master






case $1 in

  start)
    pid_guard $PIDFILE $JOB_NAME

    echo $$ > $PIDFILE
    









    mkdir -p $JENKINS_HOME
    
    
    
    



    TTF_DIR=/usr/share/fonts/truetype
    if [ -d "$TTF_DIR/ttf-dejavu" ]; then
      echo "$TTF_DIR/ttf-dejavu already exists. Don't recopy fonts."
    else
      mkdir -p $TTF_DIR
      cp -a /var/vcap/packages/ttf-dejavu/apt/usr/share/fonts/truetype/* $TTF_DIR
      echo "ttf-dejavu fonts copied"
      /var/vcap/packages/fontconfig/bin/fc-cache --force
    fi


    # SET VCAP OWNER OF JENKINS_HOME
    chown -Rf vcap:vcap $JENKINS_HOME


    # unpin plugins in .war we want to update through the pcf package
    rm -f $JENKINS_HOME/plugins/maven-plugin.*.pinned \
          $JENKINS_HOME/plugins/cloudbees-support.*.pinned


    flags=(

      -Djava.io.tmpdir="$TMPDIR"
      -Djava.awt.headless=true

      -jar /var/vcap/packages/jenkins_master_war/jenkins.war
      --httpPort=$PORT
    )



    exec chpst -v -u vcap:vcap $JAVA_HOME/bin/java $JVM_ARGS ${flags[*]} \
         >>$LOG_DIR/$JOB_NAME.stdout.log \
         2>>$LOG_DIR/$JOB_NAME.stderr.log

    ;;

  stop)
    kill_and_wait $PIDFILE

    ;;
  *)
    echo "Usage: $0 {start|stop}"

    ;;

esac
exit 0





